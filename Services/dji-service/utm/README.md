# US UTM 开发相关

## 阅读指引

本文档会依次介绍数据平台开发相关的知识，依据功能的不同分为不同的板块。先介绍总体架构，然后是按照数据流的顺序进行介绍。



## 基本信息

### 技术栈

+ Go 1.7
+ Beego 1.7.0
+ Redis 3.2
+ MySQL 
+ Nginx

### 架构

![](media/14758919345487.jpg)

服务器目前只有一台 usutm01，都是在本机运行。

+ 利用 Redis 的 Geo 功能来保存位置及相关计算，用 name 作为飞机详细信息的 key
+ 连接池，不必担心数据一致性的维护

一条飞行记录到来

+ 对应 Redis 记录两条 
    + GEOADD location lat long name (这里 name 是 droneid) - 首先需要从 set 中移除这个 name 对应的记录
    + 添加或更新 key(即上面的 name) 和 value(就是该条飞行记录的详细信息) - 包含过期时间
+ Redis 需要定期清理死键
+ 考虑走 Kafka 进行流处理，也可以是一个备份

历史数据保存在 MySQL 中，一个月以上的，按天保存到 S3 中，线上的数据使用 Redis 保存

## 开发相关

### 任务列表

+ S3 保存历史记录
+ 监控功能
    + Top 10 List
    + 利用 Redis 做 Bloomfilter
    + Last Index 用户最近访问记录，lpush, lpop
    + Fast Transaction with Lua, 小的更新逻辑
    + 监控 Redis 可以用 hypnos/redisLive
    + 考虑用位进行统计，bit 操作
+ 模拟器部分

### 部署

+ 跳板机帐号：usutm-staging
+ 密码：ag&cEqj1dy+W5O*bTof_S-xj
+ 主机名：sstg-usa-utm01(52.44.34.230; 10.1.1.21)

执行脚本 `ubuntu_install.sh`

修改权限 `sudo chmod 777 *`

安装 rz 工具上传 `sudo apt install lrzsz`

部署的时候只要把编译好的应用放到服务器上后台执行即可

环境配置使用

+ `ubuntu-nginx-install.sh`
+ `ubuntu-redis-install.sh`

### 本地测试

+ 进入 `$GOPATH/src/utm-server/` 运行 `bee run -gendoc=true -downdoc=true`
+ 测试数据库 `mysql -uroot -pAyQnuWucFNX2EtKK -h121.43.181.146 -P20097`
+ 公司的 iMac 中的 Ubuntu 虚拟机，密码 11223345


## 技术点



### 客户端

+ 确定要发送的信息
+ 确定如何匿名表示身份 - uuid 或其他加密算法
+ 地图展示测试（Objective-C 需要了解细节）
+ mobile SDK
+ 传输加密(HTTPS, TCP 加密，如何防止数据伪造)
+ 传输格式
+ WebSocket
+ 方便集成到 DJI GO 中
+ 与 Geo fencing 和 NFZ 协调（比方说在这两个区域中，不能进行空域预留）
+ 用户可以选择是否加入，可以随时退出（需要一个开关来切换）
    + opt-in means to choose to be involved in or part of the scheme
+ 用户需要联网，联网检测
+ 通知用户

### 服务器端

尽量不要太依赖 AWS，尤其是后端部分

+ 负载均衡
    + AWS ELB
+ 容器
    + AWS EC2 + Docker
+ 分布式集群管理
    + AWS Autoscaling + Ansible
+ 日志及数据备份存储
    + Amazon S3
+ 缓存 前期可以暂时不用，直连数据库或者自己用 EC2 搭建 Redis
    + Amazon ElastiCache
+ 安全性
    + VPC 隔离
+ 数据生成器
+ 消息队列
    + Kafka（方便后期与机器学习集群绑定，日志 ELK 也可以走这一套）
+ 数据库
    + MongoDB
+ 框架
+ 子服务 解耦
    + 空域检索服务（附近无人机，~~包含广播~~的消息）
    + （砍掉）~~空域规划服务（预留空域）~~
    + 天气情况服务（附近天气）
    + （砍掉）~~数据统计服务（飞行热点、飞行危险度）~~
    + 数据验证服务（每个飞机的匿名 id 以及传输加解密）
+ 虚拟机监控

国内部署考虑：阿里云的 SDK 限制


## 归档

### 术语

+ **智能辅助飞行**：指的是在联网条件下，通过后端服务器获取无人机周边的各类信息，增加环境感知能力，包含智能避障
+ **超视距飞行**：指人肉眼无法看到无人机主体，仅能通过已连接设备的屏幕来判断无人机位置的飞行，需要考虑图传因各种问题信号不稳定甚至失效的问题
+ **NASA UTM**：有 NASA 牵头的总 UTM 系统，各个公司的 UTM 系统最终都需要接入到此系统中

### 老开发计划

已失效

+ 基础系统搭建（时间：2-3 周，8/19，产出：可运行的基础系统）
    + 虚拟机申请和配置、技术可行性测试（1周）
    + 后台服务器架构设计与搭建，数据流设计与处理（1-2周）
+ 基础功能（时间 4-6 周，9/30，产出：可以实地测试的 UTM 系统）
    + 数据传输：DJI GO 与服务端连接，数据双向传输测试（1周）
    + 飞行通知：分为两种，针对起飞用户和附近用户（1-2周）
    + 预留空域：暂时以通知的形式，例如当用户飞入已预留的空域则进行通知（1-2周）
    + 天气状况：雨、雪、雹、大风、雾（1周）
    + 飞机航线状况（1周）
+ 高级功能（时间 4-6 周，11/11，产出：带高级功能的 UTM 系统）
    + 数据分析统计：热点飞行地区，危险地区（1周）
    + 用户广播消息：商业用户、娱乐用户，结合 Facebook 等社交平台（1-2周）
    + 智能防撞：具体细则还需要跟 Walter 讨论（2-4周）

注：目前此项目的开发人员只有我一人，还需要承担一部分产品经理的职责，另外因为如故团队人员调整我还需要负责数据平台事宜，故各阶段可能会比计划中延迟 1-3 周

